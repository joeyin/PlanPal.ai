const DEFAULT_CENTER={lat:43.7292468,lng:-79.6082244};let airports=[],countries=[],map,markers={},currentPositionMarker,origin,destination,originMarker,destinationMarker,flightPath;function getCurrentPositionAsync(){return new Promise((e,t)=>{navigator.geolocation.getCurrentPosition(t=>e(t),e=>t(e)),setTimeout(()=>t("timeout"),2500)})}function fitBounds(e=[]){if(0!==(e=e.filter(e=>e)).length){if(1===e.length)map?.panTo(e[0]);else{let t=new google.maps.LatLngBounds;e.map(e=>t.extend(e)),map?.fitBounds(t,200)}}}function markerHighlight(e=[]){e=e.filter(e=>e),Object.keys(markers).map(t=>{let n=markers[t];-1===e.indexOf(t)?(n.zIndex=null,n.content.classList.add("tw-opacity-65"),n.content.classList.remove("active")):(n.zIndex=1,n.content.classList.add("active"),n.content.classList.remove("tw-opacity-65"))})}function generatePolyline(e=[]){e=e.filter(e=>e),flightPath&&flightPath.setMap(null),e.length>=2&&((flightPath=new google.maps.Polyline({path:e,geodesic:!1,strokeColor:"#00150D",strokeOpacity:1,strokeWeight:3,zIndex:999})).setMap(map),flightPath.addListener("click",()=>{console.log(666)}))}function buildContent(e){let t=document.createElement("div");return t.classList.add("marker-airport-wrarpper","tw-flex","tw-flex-col","tw-items-center","loading"),t.innerHTML=`
  <div class="content">
    <div class="price">${e.city}</div>
    <div class="city">${e.state}</div>
  </div>
  <div class="marker tw-flex tw-items-center tw-justify-center">
    <i class="fa-solid fa-plane"></i>
  </div>
`,t}async function detechPosition(){let e;try{let{coords:{latitude:t,longitude:n}}=await getCurrentPositionAsync();e=new google.maps.LatLng(t,n)}catch(a){console.error(`Failed to get current position: ${a}`),e=new google.maps.LatLng(DEFAULT_CENTER.lat,DEFAULT_CENTER.lng)}setTimeout(()=>{let e=airports.filter(e=>"Toronto Pearson International Airport"===e.name)?.[0];origin[0].selectize.setValue(e.code),map.panTo(new google.maps.LatLng(e.lat,e.lon)),$(".place .placeholder-glow").remove(),$(".place .selectize-control.single").css("display","block"),$(".result-filter .placeholder-glow").remove(),$(".result-filter .selectize-control").parent().removeClass("tw-hidden"),Object.keys(markers).map(e=>markers[e].content.classList.remove("loading"))},1e3)}async function initMap(){let{Map:e}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:t}=await google.maps.importLibrary("marker");map=new e(document.getElementById("map"),{zoom:9,center:DEFAULT_CENTER,fullscreenControl:!1,mapTypeControl:!1,streetViewControl:!1,zoomControl:!1,gestureHandling:"greedy",mapTypeControl:!1,maxZoom:13,minZoom:3,streetViewControl:!1,scrollwheel:!1,mapId:"ef34fc3265e9becb"}),airports.map(e=>{let n=new t({map,content:buildContent(e),position:new google.maps.LatLng(e.lat,e.lon),title:e.name});n.content.addEventListener("mouseenter",function(){let e=n.content.classList.contains("active")||n.content.classList.contains("loading");e||(n.zIndex=2,n.content.style.opacity=1)}),n.content.addEventListener("mouseleave",function(){let e=n.content.classList.contains("active")||n.content.classList.contains("loading");e||(n.zIndex=null,n.content.style.opacity=null)}),n.addListener("click",()=>{let t=n.content.classList.contains("active")||n.content.classList.contains("loading");t||document.dispatchEvent(new CustomEvent("selectedDestination",{detail:{...e,update:!0}}))}),markers[e.code]=n,markers[e.code].marker=e})}async function onLoad(){airports=(await (await fetch("/json/airports.json")).json()).filter(e=>e.lat&&e.lon&&e.code&&["large"].includes(e.size)),countries=await (await fetch("/json/countries.json")).json(),await initMap(),await detechPosition(),document.addEventListener("selectedOrigin",e=>{originMarker=markers[e?.detail?.code],origin[0].selectize.setValue(e?.detail?.code),markerHighlight([destinationMarker?.marker?.code,originMarker?.marker?.code,]),fitBounds([originMarker?.position,destinationMarker?.position]),generatePolyline([originMarker?.position,destinationMarker?.position]),$("input[name='origin']").val(e?.detail?.code)}),document.addEventListener("selectedDestination",e=>{if(e?.detail?.update===!0)return destination[0].selectize.setValue(e?.detail?.code);markerHighlight([(destinationMarker=markers[e?.detail?.code])?.marker?.code,originMarker?.marker?.code,]),fitBounds([originMarker?.position,destinationMarker?.position]),generatePolyline([originMarker?.position,destinationMarker?.position]),$("input[name='destination']").val(e?.detail?.code)});let e={plugins:["autofill_disable"],persist:!1,preload:!0,closeAfterSelect:!0,emptyOptionLabel:"-",maxItems:1,maxOptions:99999,sortField:[{field:"country",direction:"asc"}],labelField:"From",valueField:"code",labelField:"code",searchField:["code","city","country","name"],options:airports,render:{item:function(e,t){return`
        <div class="item tw-text-base tw-font-medium tw-truncate tw-w-full tw-min-h-6" data-value="${t(e.code)}">${t(e.name)}</div>
      `},option:function(e,t){return`
        <div class="tw-flex tw-p-1.5 tw-flex-row tw-items-center">
          <div class="tw-text-lg tw-mr-4">
            ${countries.filter(n=>n.name===t(e.country))[0].emoji}
          </div>
          <div>
            <div class="tw-text-sm tw-mb-1 tw-font-medium">${t(e.name)} (${t(e.code)})</div>
            <div class="text-xs">${t(e.country)}</div>
          </div>
        </div>
      `}}};origin=$("#origin").selectize({...e,onDropdownOpen:function(){destination[0].selectize.close(),$(".form-group.place").addClass("focus"),destination[0].selectize.items.length&&$("#origin + .selectize-control").find(`.selectize-dropdown > div > [data-value='${destination[0].selectize.items[0]}']`).removeAttr("data-selectable")},onDropdownClose:function(){$(".form-group.place").removeClass("focus"),$("#origin + .selectize-control").find(".selectize-dropdown > div > div:not([data-selectable])").attr("data-selectable","true")},onChange:function(e){document.dispatchEvent(new CustomEvent("selectedOrigin",{detail:markers[e]?.marker}))}}),destination=$("#destination").selectize({...e,onDropdownOpen:function(){origin[0].selectize.close(),$(".form-group.place").addClass("focus"),origin[0].selectize.items.length&&$("#destination + .selectize-control").find(`.selectize-dropdown > div > [data-value='${origin[0].selectize.items[0]}']`).removeAttr("data-selectable")},onDropdownClose:function(){$(".form-group.place").removeClass("focus"),$("#destination + .selectize-control").find(".selectize-dropdown > div > div:not([data-selectable])").attr("data-selectable","true")},onChange:function(e){document.dispatchEvent(new CustomEvent("selectedDestination",{detail:markers[e]?.marker}))}}),$("#place-swap").click(function(){let e=origin[0].selectize.items[0],t=destination[0].selectize.items[0];origin[0].selectize.setValue(t),destination[0].selectize.setValue(e)}),$("#departureandretrun").daterangepicker({autoApply:!0,minDate:moment(),startDate:moment().add(1,"day"),endDate:moment().add(8,"day"),locale:{format:"ddd, MMM D"}}),$("#departure").daterangepicker({autoApply:!0,singleDatePicker:!0,minDate:moment(),startDate:moment().add(1,"day"),locale:{format:"ddd, MMM D"}}),$("input[name='childrens']").parent().find("button:eq(0)").attr("disabled","true").val(0),$("input[name='adults']").val(1),$("input[name='childrens'], input[name='adults']").on("input change",function(e){Number.isInteger(parseInt($(this).val()))||$(this).val(0);let t=parseInt($("input[name='adults']").val()),n=parseInt($("input[name='childrens']").val());t+n?$(".dropdown-menu.passengers #apply").removeClass("disabled"):$(".dropdown-menu.passengers #apply").addClass("disabled")}),$(".dropdown-menu.passengers #apply").click(function(e){if(e.currentTarget.classList.contains("disabled")){e.preventDefault(),e.stopPropagation();return}let t=parseInt($("input[name='adults']").val()),n=parseInt($("input[name='childrens']").val());$("#passenger").text(t+n),$("input[name='adult']").val(t),$("input[name='children']").val(n)}),$("#departureandretrun,#departure").on("show.daterangepicker",function(e,t){$(".form-group.datepicker").addClass("focus")}),$("#departureandretrun,#departure").on("hide.daterangepicker",function(e,t){$(".form-group.datepicker").removeClass("focus")}),$(".dropdown-menu .dropdown-item").click(function(e){let t=e.currentTarget.classList;t.contains("dropdown-trip-type")?selectTripType(e):t.contains("dropdown-cabin")&&selectCabin(e)}),$("button.passenger-decrease").click(function(e){let t=e.currentTarget.classList;t.contains("adults")?passengerDecrease(e,"input[name='adults']"):passengerDecrease(e,"input[name='childrens']")}),$("button.passenger-increase").click(function(e){let t=e.currentTarget.classList;t.contains("adults")?passengerIncrease(e,"input[name='adults']"):passengerIncrease(e,"input[name='childrens']")});let t=(e,t)=>({persist:!1,preload:!0,maxItems:1,dropdownParent:"body",onDropdownOpen:function(){this.$control_input[0].parentElement.parentElement.parentElement.parentElement.classList.add("focus"),e&&e(this)},onDropdownClose:function(){this.$control_input[0].parentElement.parentElement.parentElement.parentElement.classList.remove("focus"),e&&e(this)}}),n=$("#airlines").selectize({...t(()=>{a[0].selectize.close(),i[0].selectize.close()}),loadingClass:"tw-hidden",loadThrottle:99999999,maxItems:null,options:[{name:"Air Canada",value:"AC"},{name:"Porter Airlines",value:"P3"},{name:"United Airlines",value:"UA"},],valueField:"value",labelField:"name",render:{item:function(e,t){return`<span>${t(e.name)}</span>`}}}),a=$("#stops").selectize({...t(()=>{n[0].selectize.close(),i[0].selectize.close()}),options:[{name:"Any number of stops",value:0},{name:"Nonstop only",value:1},{name:"1 stop or fewer",value:2},{name:"2 stop or fewer",value:3},],valueField:"value",labelField:"name"}),i=$("#max_price").selectize({...t(()=>{n[0].selectize.close(),a[0].selectize.close()}),options:[{name:"0 - 1,000 CAD",value:1e3},{name:"1,000 - 2,000 CAD",value:2e3},{name:"Unlimited",value:0},],valueField:"value",labelField:"name"})}function passengerDecrease(e,t){e.preventDefault(),e.stopPropagation(),$(t).val()>0&&$(t).val(parseInt($(t).val())-1).trigger("change"),0==$(t).val()&&$(t).parent().find("button:eq(0)").attr("disabled","true")}function passengerIncrease(e,t){e.preventDefault(),e.stopPropagation(),$(t).val(parseInt($(t).val())+1).trigger("change"),$(t).parent().find("button:eq(0)").removeAttr("disabled")}function selectTripType(e){let t=$(e.target).text();$("#tripType").text(t),$("input[name='tripType']").val(t),"One way"===t?($("#oneway-trip").removeClass("tw-hidden"),$("#round-trip").addClass("tw-hidden")):($("#oneway-trip").addClass("tw-hidden"),$("#round-trip").removeClass("tw-hidden"))}function selectCabin(e){let t=$(e.target).text();$("#cabin").text(t),$("input[name='cabin']").val(t)}window.onload=onLoad;